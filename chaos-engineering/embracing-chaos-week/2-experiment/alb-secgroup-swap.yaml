title: "ALB security group swap"
description: |
  Verify application security configuration.
  Swapping ALB (Application Load Balancer) security groups with a dummy group
  should stop requests from reaching the target application.

contributions:
  security: "high"
  reliability: "low"
  scalability: "low"

configuration:
  stress_duration: "3m"
  app_url: "http://localhost:8000"
  alb_name:               "dummy"
  alb_arn_suffix:         "dummy"
  dummy_alb_secgroup:     "dummy"
  original_alb_secgroup:  "dummy"

method:
  - type: action
    name: "alb-secgroup-swap"
    provider:
      type: python
      module: chaosaws.elbv2.actions
      func: set_security_groups
      arguments:
        load_balancer_names:
          - "${alb_name}"
        security_group_ids:
          - "${dummy_alb_secgroup}"

  - type: action
    name: "stress-endpoint-with-simulated-traffic"
    provider:
      type: python
      module: chaosk6.actions
      func: stress_endpoint
      arguments:
        endpoint: "${app_url}"
        vus: 2
        duration: ${stress_duration}

steady-state-hypothesis:
  title: "Ningx web server is available"
  probes:
    - type: probe
      name: "should-have-no-successful-requests"
      tolerance: 0
      provider:
        type: python
        module: chaosaws.cloudwatch.probes
        func: get_metric_statistics
        arguments:
          namespace: "AWS/ApplicationELB"
          metric_name: HTTPCode_Target_2XX_Count
          dimensions:
            - Name: "LoadBalancer"
              Value: "${alb_arn_suffix}"
          statistic: "Sum"
          unit: "Count"
          duration: 60

rollbacks:
  - type: action
    name: "alb-secgroup-reset"
    provider:
      type: python
      module: chaosaws.elbv2.actions
      func: set_security_groups
      arguments:
        load_balancer_names:
          - "${alb_name}"
        security_group_ids:
          - "${original_alb_secgroup}"
